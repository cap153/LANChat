# æ–‡ä»¶ä¼ è¾“è°ƒè¯•æŒ‡å—

## é—®é¢˜ç°è±¡

- æ¡Œé¢ç«¯ï¼š`æ–‡ä»¶å‘é€å¤±è´¥: å‘é€å¤±è´¥: ä¸Šä¼ å¤±è´¥: HTTP 400 Bad Request`
- Web ç«¯ï¼š`æ–‡ä»¶å‘é€å¤±è´¥: ä¸Šä¼ å¤±è´¥: NetworkError when attempting to fetch resource.`

## è°ƒè¯•æ­¥éª¤

### 1. å¯åŠ¨ Web æœåŠ¡å™¨å¹¶æŸ¥çœ‹æ—¥å¿—

```bash
# å¯åŠ¨ç¬¬ä¸€ä¸ªå®ä¾‹
./src-tauri/target/debug/lanchat-web

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯å¯åŠ¨ç¬¬äºŒä¸ªå®ä¾‹
./src-tauri/target/debug/lanchat-web --port 9999
```

### 2. æµ‹è¯• API æ˜¯å¦æ­£å¸¸å·¥ä½œ

```bash
# æµ‹è¯•ä¸Šä¼ æ¥å£
./test-upload-api.sh
```

é¢„æœŸè¾“å‡ºåº”è¯¥åŒ…å«ï¼š
```
[Web Server] æ”¶åˆ°æ–‡ä»¶ä¸Šä¼ è¯·æ±‚
[Web Server] è§£æå­—æ®µ: peer_id
[Web Server] peer_id: test-peer-123
[Web Server] è§£æå­—æ®µ: file
[Web Server] æ–‡ä»¶å: test_file.txt
[Web Server] æ–‡ä»¶å¤§å°: XX å­—èŠ‚
[Web Server] æ¥æ”¶æ–‡ä»¶: test_file.txt, å¤§å°: XX å­—èŠ‚
[Web Server] ä¿å­˜æ–‡ä»¶åˆ°: ...
[Web Server] æ–‡ä»¶ä¿å­˜æˆåŠŸ: ...
```

### 3. æ£€æŸ¥å‰ç«¯æ—¥å¿—

æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰ï¼ŒæŸ¥çœ‹ Console æ ‡ç­¾é¡µã€‚

å‘é€æ–‡ä»¶æ—¶åº”è¯¥çœ‹åˆ°ï¼š
```
[JS-API] ä¸Šä¼ æ–‡ä»¶åˆ°: http://192.168.x.x:8888/api/upload
[JS-API] æ–‡ä»¶ä¿¡æ¯: filename.txt 1234 text/plain
[JS-API] peer_id: xxx-xxx-xxx
[JS-API] å“åº”çŠ¶æ€: 200 OK
[JS-API] æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: {...}
```

### 4. å¸¸è§é—®é¢˜æ’æŸ¥

#### é—®é¢˜ 1: NetworkError
- **åŸå› **: CORS é…ç½®é—®é¢˜æˆ–ç½‘ç»œä¸é€š
- **æ£€æŸ¥**: 
  - ç¡®è®¤ä¸¤ä¸ªå®ä¾‹éƒ½åœ¨è¿è¡Œ
  - ç¡®è®¤å¯ä»¥äº’ç›¸ ping é€š
  - æŸ¥çœ‹åç«¯æ˜¯å¦æ”¶åˆ°è¯·æ±‚

#### é—®é¢˜ 2: HTTP 400 Bad Request
- **åŸå› **: è¯·æ±‚æ ¼å¼ä¸æ­£ç¡®
- **æ£€æŸ¥åç«¯æ—¥å¿—**:
  - æ˜¯å¦æ˜¾ç¤º `[Web Server] æ”¶åˆ°æ–‡ä»¶ä¸Šä¼ è¯·æ±‚`
  - æ˜¯å¦æ˜¾ç¤º `ç¼ºå°‘æ–‡ä»¶ (name=..., size=...)`
  - peer_id å’Œ file å­—æ®µæ˜¯å¦éƒ½è§£ææˆåŠŸ

#### é—®é¢˜ 3: æ–‡ä»¶åä¸ºç©ºæˆ–æ•°æ®ä¸ºç©º
- **åŸå› **: multipart è§£æå¤±è´¥
- **è§£å†³**: æ£€æŸ¥å‰ç«¯å‘é€çš„ FormData æ ¼å¼

### 5. æ‰‹åŠ¨æµ‹è¯• curl å‘½ä»¤

```bash
# åˆ›å»ºæµ‹è¯•æ–‡ä»¶
echo "test content" > test.txt

# ä¸Šä¼ åˆ°ç¬¬ä¸€ä¸ªå®ä¾‹
curl -X POST http://localhost:8888/api/upload \
  -F "peer_id=manual-test" \
  -F "file=@test.txt"

# ä¸Šä¼ åˆ°ç¬¬äºŒä¸ªå®ä¾‹
curl -X POST http://localhost:9999/api/upload \
  -F "peer_id=manual-test" \
  -F "file=@test.txt"
```

### 6. æ£€æŸ¥æ•°æ®åº“

```bash
# æŸ¥çœ‹æ•°æ®åº“è·¯å¾„
ls -la ~/.local/share/com.lanchat.app/

# æŸ¥çœ‹æ¶ˆæ¯è®°å½•
sqlite3 ~/.local/share/com.lanchat.app/lanchat.db "SELECT * FROM messages WHERE msg_type='file';"
```

### 7. æ£€æŸ¥ä¸‹è½½ç›®å½•

```bash
# æŸ¥çœ‹ä¸´æ—¶ä¸‹è½½ç›®å½•
ls -la /tmp/lanchat_downloads/
```

## é¢„æœŸè¡Œä¸º

1. Web ç«¯ç‚¹å‡» ğŸ“ æŒ‰é’® â†’ é€‰æ‹©æ–‡ä»¶
2. å‰ç«¯å‘é€ POST è¯·æ±‚åˆ° `http://{peer_addr}/api/upload`
3. åç«¯æ¥æ”¶ multipart æ•°æ®
4. åç«¯ä¿å­˜æ–‡ä»¶åˆ°ä¸‹è½½ç›®å½•
5. åç«¯ä¿å­˜è®°å½•åˆ°æ•°æ®åº“
6. è¿”å› JSON: `{"success": true, "file_id": "...", "file_name": "...", "file_size": ...}`
7. å‰ç«¯æ˜¾ç¤ºæ–‡ä»¶æ¶ˆæ¯
8. å¯¹æ–¹è½®è¯¢åˆ°æ–°æ¶ˆæ¯ï¼Œæ˜¾ç¤ºæ–‡ä»¶ï¼ˆå¯ç‚¹å‡»ä¸‹è½½ï¼‰

## å¦‚æœè¿˜æ˜¯å¤±è´¥

è¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
1. åç«¯å®Œæ•´æ—¥å¿—ï¼ˆä»å¯åŠ¨åˆ°å‘é€æ–‡ä»¶ï¼‰
2. å‰ç«¯ Console å®Œæ•´æ—¥å¿—
3. curl æµ‹è¯•ç»“æœ
4. ç½‘ç»œæ‹“æ‰‘ï¼ˆæ˜¯å¦åœ¨åŒä¸€å±€åŸŸç½‘ï¼‰
